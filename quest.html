<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hehe Quest | Encrypted Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Outfit:wght@300;600;900&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00f3ff; --error: #ff003c; --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.1); }
        body { background: url('https://images.unsplash.com/photo-1614850523296-d8c1af93d400?q=80&w=2070&auto=format&fit=crop') center/cover no-repeat fixed; color: white; font-family: 'Outfit', sans-serif; overflow: hidden; height: 100vh; user-select: none; }
        body::before { content: ""; position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); z-index: -1; }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        @keyframes zenithFloat { 0%, 100% { transform: translate3d(0, 0, 0); } 50% { transform: translate3d(0, 15px, 0); } }
        .startup-animate { animation: zenithFloat 8s infinite ease-in-out; }

        .zenith-card { background: var(--glass); backdrop-filter: blur(30px); border: 1px solid var(--border); border-radius: 24px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin: 10px; }
        .zenith-card:hover { border-color: var(--neon); box-shadow: 0 10px 40px rgba(0, 243, 255, 0.15); }

        .leader-aura { border-color: var(--neon) !important; box-shadow: 0 0 25px rgba(0, 243, 255, 0.4); position: relative; overflow: hidden; }
        .leader-aura::after { content: "TOP ELITE"; position: absolute; top: 0; right: 20px; background: var(--neon); color: black; font-size: 8px; font-weight: 900; padding: 2px 8px; border-radius: 0 0 8px 8px; }

        @keyframes modalPopIn { 0% { opacity: 0; transform: scale(0.5) rotateX(-30deg); } 100% { opacity: 1; transform: scale(1) rotateX(0); } }
        @keyframes modalPopOut { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(1.2); filter: blur(10px); } }
        .modal-active { animation: modalPopIn 0.5s cubic-bezier(0.23, 1, 0.32, 1) forwards; }
        .modal-exit { animation: modalPopOut 0.4s ease-in forwards !important; }

        @keyframes matrixFlicker { 0% { opacity: 0.2; filter: hue-rotate(90deg) brightness(2); } 50% { opacity: 0.8; filter: hue-rotate(0deg) brightness(1); } 100% { opacity: 1; } }
        .shuffling-matrix { animation: matrixFlicker 0.4s ease-in-out; }

        @keyframes singleImpact { 0% { transform: translateX(-10px); } 20% { transform: translateX(10px); } 40% { transform: translateX(-10px); } 60% { transform: translateX(10px); } 100% { transform: translateX(0); } }
        .error-impact { animation: singleImpact 0.4s ease-out; border: 2px solid var(--error) !important; }
        
        @keyframes popUpText { 0% { opacity: 0; transform: translateY(20px); } 20% { opacity: 1; transform: translateY(-40px); } 80% { opacity: 1; transform: translateY(-60px); } 100% { opacity: 0; transform: translateY(-100px); } }
        .combat-msg { position: fixed; left: 50%; top: 40%; transform: translateX(-50%); pointer-events: none; z-index: 10000; animation: popUpText 2s forwards; }

        @keyframes tabFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-content-active { animation: tabFade 0.4s ease-out forwards; }

        @keyframes nameSwitchFade { from { opacity: 0; } to { opacity: 1; } }
        .name-fade-active { animation: nameSwitchFade 0.5s ease-in-out; }

        .scroller::-webkit-scrollbar { width: 4px; }
        .scroller::-webkit-scrollbar-thumb { background: rgba(0, 243, 255, 0.3); border-radius: 10px; }
        .screen-hidden { display: none !important; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loader" class="fixed inset-0 z-[9999] hidden flex flex-col items-center justify-center bg-black font-['Orbitron'] text-cyan-400">
        <div class="w-24 h-24 border-4 border-t-cyan-400 border-white/10 rounded-full animate-spin mb-8"></div>
        <div id="loader-text" class="tracking-[0.5em] text-xl animate-pulse uppercase">PROCESSING...</div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 z-[5000] hidden items-center justify-center bg-black/90 backdrop-blur-3xl" onclick="closeModal()"></div>

    <main id="view-start" class="h-full flex flex-col items-center justify-center pt-20">
        <div class="zenith-card p-10 w-full max-w-xl startup-animate">
            <h1 class="text-6xl font-black italic font-['Orbitron'] text-center mb-8 uppercase tracking-tight">CLUSTER<br><span class="text-cyan-400">QUEST</span></h1>
            <div class="space-y-4">
                <input id="in-name" type="text" placeholder="Batch Number" class="w-full bg-white/5 border-b border-white/20 p-4 outline-none focus:border-cyan-400 text-white">
                <div class="grid grid-cols-2 gap-2">
                    <input id="in-pass" type="password" placeholder="Set Key" class="bg-white/5 border-b border-white/20 p-4 outline-none focus:border-cyan-400 text-white">
                    <input id="in-pass-conf" type="password" placeholder="Confirm Key" class="bg-white/5 border-b border-white/20 p-4 outline-none focus:border-cyan-400 text-white">
                </div>
                <textarea id="in-roster" placeholder="Enter Learners (One per line)..." class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 h-40 outline-none focus:border-cyan-400 resize-none text-white"></textarea>
                <div class="flex gap-4">
                    <button onclick="launchSequence()" class="flex-1 bg-cyan-500 py-4 rounded-full text-black font-black hover:bg-white transition-all transform active:scale-95">BEGIN QUEST</button>
                    <button onclick="openQuestArchive()" class="px-8 bg-white/10 rounded-full text-[10px] font-black tracking-widest hover:bg-white/20">ARCHIVES</button>
                </div>
            </div>
        </div>
    </main>

    <main id="view-arena" class="screen-hidden h-full flex flex-col max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-4 px-4 h-16">
            <button onclick="exitToMenu()" class="text-[10px] font-bold opacity-40 hover:opacity-100 hover:text-red-400 tracking-widest transition-all">‚â™ DISCONNECT</button>
            <div class="flex bg-white/5 p-1 rounded-full border border-white/10">
                <button onclick="changeTab('cluster')" id="tab-c" class="px-5 py-2 rounded-full text-[9px] font-black bg-cyan-500 text-black">CLUSTERS</button>
                <button onclick="changeTab('hero')" id="tab-h" class="px-5 py-2 rounded-full text-[9px] font-black opacity-40">LEARNER</button>
                <button onclick="changeTab('nick')" id="tab-n" class="px-5 py-2 rounded-full text-[9px] font-black opacity-40">NICKNAMES</button>
                <button onclick="changeTab('history')" id="tab-hist" class="px-5 py-2 rounded-full text-[9px] font-black opacity-40">HISTORY</button>
                <button onclick="changeTab('leaderboard')" id="tab-lb" class="px-5 py-2 rounded-full text-[9px] font-black opacity-40 text-yellow-500">LEADER BOARD</button>
            </div>
            <button onclick="triggerFinishSecurity()" class="bg-white text-black px-8 py-2 rounded-full font-black text-[10px] hover:bg-cyan-400 transition-all">FINISH</button>
        </header>
        <div id="arena-content" class="scroller flex-1 overflow-y-auto px-2 pb-10"></div>
    </main>

    <script>
        let state = JSON.parse(localStorage.getItem('Zenith_V7')) || { active: {}, deleted: {} };
        let currentKey = null;
        let activeTab = 'cluster';
        let stagingClusters = [];
        let initialPlayers = [];
        let heroNameMode = 'nickname';

        const sounds = {
            transition: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
            shuffle: new Audio('https://assets.mixkit.co/active_storage/sfx/1110/1110-preview.mp3'),
            error: new Audio('https://assets.mixkit.co/active_storage/sfx/2955/2955-preview.mp3'),
            click: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
            gain: new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3'),
            loss: new Audio('https://assets.mixkit.co/active_storage/sfx/2020/2020-preview.mp3'),
            tick: new Audio('https://assets.mixkit.co/active_storage/sfx/1103/1103-preview.mp3'),
            victory: new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3'),
            success: new Audio('https://assets.mixkit.co/active_storage/sfx/1433/1433-preview.mp3'),
            congrats: new Audio('https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3')
        };
        const playSound = (s) => { if(sounds[s]) { sounds[s].currentTime = 0; sounds[s].play().catch(()=>{}); }};

        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') playSound('click');
        });

        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = (e) => {
            if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && [73, 74, 67].includes(e.keyCode)) || (e.ctrlKey && e.keyCode == 85)) return false;
        };

        const save = () => localStorage.setItem('Zenith_V7', JSON.stringify(state));

        function triggerLoading(text, callback) {
            playSound('transition');
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            loaderText.innerText = text;
            loader.classList.remove('hidden');
            setTimeout(() => {
                loader.classList.add('hidden');
                if(callback) callback();
            }, 1500);
        }

        function triggerError(msg) {
            playSound('error');
            const overlay = document.getElementById('modal-overlay');
            overlay.innerHTML = `
                <div id="error-box" class="modal-active zenith-card p-10 text-center error-impact max-w-sm" onclick="event.stopPropagation()">
                    <h2 class="text-red-500 font-['Orbitron'] font-black text-2xl mb-2">FAILURE</h2>
                    <p class="text-[10px] opacity-80 tracking-widest uppercase mb-8 text-white">${msg}</p>
                    <button onclick="closeModal()" class="w-full bg-red-600 py-3 rounded-full text-xs font-black">RETRY</button>
                </div>
            `;
            overlay.style.display = 'flex';
        }

        function showModal(html) {
            const overlay = document.getElementById('modal-overlay');
            overlay.innerHTML = `<div class="modal-active flex items-center justify-center w-full h-full p-4">${html}</div>`;
            overlay.style.display = 'flex';
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const target = overlay.querySelector('.modal-active');
            if(target) {
                target.classList.add('modal-exit');
                setTimeout(() => {
                    overlay.style.display = 'none';
                    overlay.innerHTML = "";
                }, 400);
            }
        }

        function launchSequence() {
            const roster = document.getElementById('in-roster').value.trim();
            const pass = document.getElementById('in-pass').value;
            const conf = document.getElementById('in-pass-conf').value;
            if(!roster || pass !== conf || pass.length < 1) { triggerError("FIELD ERROR OR KEY MISMATCH"); return; }
            initialPlayers = roster.split('\n').filter(n => n.trim()).map(n => ({ 
                id: 'p-'+Math.random().toString(36).substr(2,5), 
                name: n.trim(), 
                nickname: n.trim(), 
                score: 0,
                changeCount: 0 
            }));
            initShuffleRoom(true);
        }

        function initShuffleRoom(isFirstLoad = false) {
            const countInput = document.getElementById('cluster-count');
            let count = countInput ? parseInt(countInput.value) : 2;
            if(count > initialPlayers.length) count = initialPlayers.length;
            if(count < 1) count = 1;

            playSound('shuffle');
            const grid = document.getElementById('shuffle-grid');
            if(grid) grid.classList.add('shuffling-matrix');
            
            stagingClusters = Array.from({length: count}, (_, i) => ({ id: i+1, members: [], multiplier: 1 }));
            const shuffled = [...initialPlayers].sort(() => Math.random() - 0.5);
            shuffled.forEach((p, i) => stagingClusters[i % count].members.push(p));
            stagingClusters.forEach(c => {
                const maxTeam = Math.max(...stagingClusters.map(cl => cl.members.length));
                c.multiplier = parseFloat((maxTeam / c.members.length).toFixed(2));
            });
            setTimeout(() => { renderShuffle(isFirstLoad); }, 400);
        }

        function renderShuffle(isFirstLoad) {
            const gridHtml = stagingClusters.map(c => `
                <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-[9px] text-cyan-400 font-bold italic">CLUSTER ${c.id}</div>
                        <div class="text-[9px] bg-cyan-400/20 px-2 rounded text-cyan-400">x${c.multiplier}</div>
                    </div>
                    <div class="space-y-1">${c.members.map(m => `<div class="text-[11px] opacity-70 text-white">${m.name}</div>`).join('')}</div>
                </div>
            `).join('');

            showModal(`
                <div id="shuffle-container" class="zenith-card p-8 max-w-4xl w-full flex flex-col max-h-[90vh]" onclick="event.stopPropagation()">
                    <h2 class="font-['Orbitron'] text-cyan-400 text-xl mb-4 text-center tracking-[0.3em]">DIVISION STAGING</h2>
                    <div class="flex items-center justify-center gap-4 mb-6 bg-white/5 p-4 rounded-xl">
                        <span class="text-[10px] uppercase opacity-40 text-white">Cluster Count (Max ${initialPlayers.length}):</span>
                        <input id="cluster-count" type="number" min="1" max="${initialPlayers.length}" value="${stagingClusters.length}" onkeydown="if(event.key==='Enter') initShuffleRoom(false)" class="bg-cyan-500/10 border border-cyan-500/30 w-16 text-center font-bold py-1 rounded outline-none text-white">
                    </div>
                    <div id="shuffle-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3 overflow-y-auto scroller mb-8">${gridHtml}</div>
                    <div class="flex flex-col gap-3">
                        <button onclick="initShuffleRoom(false)" class="w-full bg-white/10 py-4 rounded-full font-bold text-[10px] hover:bg-white/20 uppercase tracking-widest text-white">Re-Shuffle Matrix</button>
                        <button onclick="finalizeStart()" class="w-full bg-cyan-500 py-4 rounded-full text-black font-black text-xs uppercase tracking-widest">Confirm Final Division</button>
                        <button onclick="closeModal()" class="w-full py-2 text-[10px] opacity-40 hover:opacity-100 uppercase tracking-widest text-white">Go Back</button>
                    </div>
                </div>
            `);
        }

        function finalizeStart() {
            const name = document.getElementById('in-name').value.trim() || "UNNAMED EXPEDITION";
            const pass = document.getElementById('in-pass').value;
            const key = 'q-' + Date.now();
            state.active[key] = { name, clusters: stagingClusters, pass, history: [], date: new Date().toLocaleDateString() };
            currentKey = key; save(); closeModal();
            triggerLoading("ESTABLISHING NEURAL LINK...", () => {
                document.getElementById('view-start').classList.add('screen-hidden');
                document.getElementById('view-arena').classList.remove('screen-hidden');
                changeTab('cluster');
            });
        }

        function openQuestArchive() {
            playSound('transition');
            const activeKeys = Object.keys(state.active);
            const hasDeleted = state.deleted && Object.keys(state.deleted).length > 0;
            showModal(`
                <div class="zenith-card p-8 w-full max-w-lg flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                    <h2 class="font-['Orbitron'] text-cyan-400 text-center mb-6 text-xl tracking-widest">ARCHIVED CORES</h2>
                    <div class="scroller overflow-y-auto space-y-3 mb-6 flex-1">
                        ${activeKeys.map(k => `
                            <div class="bg-white/5 p-4 rounded-2xl flex justify-between items-center border border-white/5">
                                <span class="text-sm font-bold text-white">${state.active[k].name}</span>
                                <div class="flex gap-2">
                                    <button onclick="openEncryptedQuest('${k}')" class="bg-cyan-500 text-black px-4 py-2 rounded-full text-[10px] font-black">DECRYPT</button>
                                    <button onclick="confirmDeleteHandshake('${k}', false)" class="bg-red-500/20 text-red-500 border border-red-500/50 px-3 py-2 rounded-full text-[10px] font-black">‚úï</button>
                                </div>
                            </div>
                        `).join('') || '<p class="text-center opacity-20 text-[10px] py-10 uppercase text-white">No active cores made</p>'}
                    </div>
                    ${hasDeleted ? `<button onclick="openRecentlyDeleted()" class="mb-4 text-[9px] text-yellow-500 font-bold tracking-[0.2em] hover:text-white uppercase">View Recently Deleted (${Object.keys(state.deleted).length})</button>` : ''}
                    <button onclick="closeModal()" class="w-full bg-white/10 py-4 rounded-full text-[10px] font-black uppercase text-white">Close</button>
                </div>
            `);
        }

        function confirmDeleteHandshake(k, isPermanent) {
            showModal(`
                <div class="zenith-card p-10 text-center max-w-sm" onclick="event.stopPropagation()">
                    <h2 class="text-red-500 font-['Orbitron'] font-black mb-4 uppercase">AUTHORIZE ${isPermanent ? 'ERASURE' : 'PURGE'}</h2>
                    <p class="text-[10px] opacity-60 mb-6 uppercase text-white">Enter "delete" to confirm.</p>
                    <input id="del-key" type="text" placeholder="TYPE KEY" onkeydown="if(event.key==='Enter') handleDeleteAuth('${k}', ${isPermanent})" class="w-full bg-white/5 border-b border-red-500 p-4 text-center outline-none mb-8 text-white uppercase">
                    <div class="flex gap-2">
                        <button onclick="handleDeleteAuth('${k}', ${isPermanent})" class="flex-1 bg-red-600 py-3 rounded-full text-xs font-black">CONFIRM</button>
                        <button onclick="${isPermanent ? 'openRecentlyDeleted()' : 'openQuestArchive()'}" class="flex-1 bg-white/10 py-3 rounded-full text-xs font-black">CANCEL</button>
                    </div>
                </div>
            `);
        }

        function handleDeleteAuth(k, isPermanent) {
            const input = document.getElementById('del-key').value.toLowerCase();
            if(input === 'delete') {
                if(isPermanent) { delete state.deleted[k]; openRecentlyDeleted(); }
                else { state.deleted[k] = state.active[k]; delete state.active[k]; openQuestArchive(); }
                save();
            } else triggerError("INVALID DELETE KEY");
        }

        function openRecentlyDeleted() {
            const keys = Object.keys(state.deleted || {});
            showModal(`
                <div class="zenith-card p-8 w-full max-w-lg flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
                    <h2 class="font-['Orbitron'] text-yellow-500 text-center mb-6 text-xl tracking-widest">TRASH BIN</h2>
                    <div class="scroller overflow-y-auto space-y-3 mb-6 flex-1">
                        ${keys.map(k => `
                            <div class="bg-white/5 p-4 rounded-2xl flex justify-between items-center border border-yellow-500/20">
                                <span class="text-sm font-bold opacity-60 text-white">${state.deleted[k].name}</span>
                                <div class="flex gap-2">
                                    <button onclick="state.active['${k}'] = state.deleted['${k}']; delete state.deleted['${k}']; save(); openRecentlyDeleted();" class="bg-yellow-600 text-black px-4 py-2 rounded-full text-[10px] font-black">RESTORE</button>
                                    <button onclick="confirmDeleteHandshake('${k}', true)" class="bg-red-900 text-white px-3 py-2 rounded-full text-[10px] font-black">ERASE</button>
                                </div>
                            </div>
                        `).join('') || '<p class="text-center opacity-20 text-[10px] py-10 uppercase text-white">No record</p>'}
                    </div>
                    <button onclick="openQuestArchive()" class="w-full bg-white/10 py-4 rounded-full text-[10px] font-black uppercase text-white">Back</button>
                </div>
            `);
        }

        function openEncryptedQuest(k) {
            showModal(`
                <div class="zenith-card p-10 text-center max-w-sm" onclick="event.stopPropagation()">
                    <h2 class="font-['Orbitron'] font-black text-xl mb-6 text-white">IDENTITY VERIFICATION</h2>
                    <input id="unlock-pass" type="password" placeholder="ENTER KEY" autofocus onkeydown="if(event.key==='Enter') verifyKey('${k}')" class="w-full bg-white/5 border-b border-cyan-400 p-4 text-center outline-none mb-8 text-white">
                    <button onclick="verifyKey('${k}')" class="w-full bg-cyan-500 py-3 rounded-full text-black font-black text-xs">DECRYPT</button>
                </div>
            `);
        }

        function verifyKey(k) {
            if(document.getElementById('unlock-pass').value === state.active[k].pass) {
                currentKey = k; closeModal();
                triggerLoading("DECRYPTING...", () => {
                    document.getElementById('view-start').classList.add('screen-hidden');
                    document.getElementById('view-arena').classList.remove('screen-hidden');
                    renderArena();
                });
            } else triggerError("ACCESS DENIED");
        }

        function openPointAction(isDeduct, type, id, name) {
            playSound('transition');
            const presets = [5, 10, 20, 50];
            const presetHtml = presets.map(p => `<button onclick="confirmPointTransmit(${isDeduct}, '${type}', '${id}', '${name}', ${p})" class="bg-white/10 hover:bg-white/20 border border-white/10 px-4 py-2 rounded-lg text-[10px] font-bold text-white">+${p}</button>`).join('');
            showModal(`
                <div class="zenith-card p-10 w-full max-w-md text-center" onclick="event.stopPropagation()">
                    <h2 class="font-['Orbitron'] font-black text-xl mb-1 ${isDeduct ? 'text-red-500' : 'text-cyan-400'}">${isDeduct ? 'PENALTY' : 'GRANT XP'}</h2>
                    <p class="text-[10px] opacity-30 mb-6 uppercase text-white">${name}</p>
                    <input id="point-in" type="number" placeholder="0" autofocus class="w-full bg-transparent text-center text-7xl font-black outline-none mb-4 text-white">
                    <div class="flex justify-center gap-2 mb-8">${presetHtml}</div>
                    <button onclick="confirmPointTransmit(${isDeduct}, '${type}', '${id}', '${name}', parseInt(document.getElementById('point-in').value))" class="w-full bg-white text-black py-4 rounded-full font-black text-xs">TRANSMIT DATA</button>
                </div>
            `);
        }

        function confirmPointTransmit(isDeduct, type, id, name, val) {
            if(!val || val <= 0) { triggerError("INVALID DATA"); return; }
            showModal(`
                <div class="zenith-card p-10 w-full max-w-sm text-center" onclick="event.stopPropagation()">
                    <h2 class="font-['Orbitron'] font-black text-xl mb-4 text-white">CONFIRM ACTION</h2>
                    <p class="text-sm mb-8 text-white">Do you wish to <span class="${isDeduct?'text-red-500':'text-cyan-400'} font-bold">${isDeduct?'DEDUCT':'ADD'} ${val} XP</span> for <br><span class="opacity-60 italic">${name}</span>?</p>
                    <div class="flex gap-2">
                        <button onclick="executePoints(${isDeduct}, '${type}', '${id}', '${name}', ${val})" class="flex-1 bg-cyan-500 py-3 rounded-full text-black font-black text-xs">YES</button>
                        <button onclick="closeModal()" class="flex-1 bg-white/10 py-3 rounded-full text-white font-black text-xs">CANCEL</button>
                    </div>
                </div>
            `);
        }

        function executePoints(isDeduct, type, id, name, val) {
            const q = state.active[currentKey];
            let mult = 1;
            if(type === 'cluster') mult = q.clusters.find(c => c.id == id).multiplier;
            else mult = q.clusters.find(c => c.members.some(m => m.id === id)).multiplier;
            const finalVal = Math.round((isDeduct ? -val : val) * mult);
            if(type === 'cluster') q.clusters.find(c => c.id == id).members.forEach(m => m.score += finalVal);
            else q.clusters.forEach(c => { const h = c.members.find(x => x.id === id); if(h) h.score += finalVal; });
            q.history.unshift({ date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), target: name, amount: finalVal, note: isDeduct ? "DEBUFF" : "XP GAIN" });
            
            if(isDeduct) playSound('loss'); else playSound('gain');
            
            save(); closeModal(); renderArena();
            triggerCombatText(finalVal, isDeduct);
        }

        function triggerCombatText(amt, isDeduct) {
            const positive = ["EXCELLENT!", "SUPREME!", "DOMINANCE!", "LEVEL UP!", "POWERFUL!", "SYNCED!"];
            const negative = ["CRITICAL!", "WEAKNESS!", "FAILURE!", "REDUCE!"];
            const msg = isDeduct ? negative[Math.floor(Math.random()*negative.length)] : positive[Math.floor(Math.random()*positive.length)];
            const div = document.createElement('div');
            div.className = 'combat-msg text-center';
            div.innerHTML = `<div class="font-['Orbitron'] font-black ${isDeduct ? 'text-red-500' : 'text-cyan-400'} text-4xl mb-2">${msg}</div><div class="text-6xl font-black text-white">${amt}</div>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 2000);
        }

        function saveAllNicknames() {
            const q = state.active[currentKey];
            let hasChanges = false;
            
            q.clusters.forEach(c => {
                c.members.forEach(hero => {
                    const input = document.getElementById(`nick-in-${hero.id}`);
                    if (input) {
                        const newNick = input.value.trim();
                        if (newNick && newNick !== hero.nickname) {
                            q.history.unshift({ 
                                date: new Date().toLocaleDateString(), 
                                time: new Date().toLocaleTimeString(), 
                                target: hero.name, 
                                amount: "ID UPDATE", 
                                note: `${hero.nickname} -> ${newNick}` 
                            });
                            hero.nickname = newNick;
                            hero.changeCount = (hero.changeCount || 0) + 1;
                            hasChanges = true;
                        }
                    }
                });
            });

            if(hasChanges) {
                save();
                playSound('success');
                triggerLoading("SYNCING DATABASE...", () => renderArena());
                triggerCombatText("SYNCED", false);
            } else {
                triggerError("NO CHANGES DETECTED");
            }
        }

        function changeTab(t) {
            playSound('transition');
            activeTab = t;
            ['tab-c', 'tab-h', 'tab-n', 'tab-lb', 'tab-hist'].forEach(id => {
                document.getElementById(id)?.classList.add('opacity-40');
                document.getElementById(id)?.classList.remove('bg-cyan-500', 'text-black');
            });
            const activeId = t === 'cluster' ? 'tab-c' : (t === 'hero' ? 'tab-h' : (t === 'nick' ? 'tab-n' : (t === 'history' ? 'tab-hist' : 'tab-lb')));
            document.getElementById(activeId).classList.remove('opacity-40');
            document.getElementById(activeId).classList.add('bg-cyan-500', 'text-black');
            
            const arena = document.getElementById('arena-content');
            arena.classList.remove('tab-content-active');
            void arena.offsetWidth;
            arena.classList.add('tab-content-active');
            
            renderArena();
        }

        function renderArena() {
            const q = state.active[currentKey];
            const content = document.getElementById('arena-content');
            content.innerHTML = "";
            if(activeTab === 'cluster') {
                q.clusters.forEach(c => {
                    const total = c.members.reduce((s,m)=>s+m.score,0);
                    content.innerHTML += `
                        <div class="zenith-card p-6 mb-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-2xl font-black italic font-['Orbitron']">CLUSTER ${c.id}</h3>
                                    <button onclick="viewClusterMembers(${c.id})" class="text-[10px] font-bold border border-white/10 px-4 py-1 rounded-full hover:bg-white/10 mt-2 text-white">VIEW MEMBERS</button>
                                </div>
                                <div class="text-right">
                                    <div class="text-4xl font-black text-cyan-400">${total}</div>
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="openPointAction(true, 'cluster', ${c.id}, 'Cluster ${c.id}')" class="bg-red-500/10 text-red-500 px-3 py-1 rounded-full text-[8px] font-bold">MIN</button>
                                        <button onclick="openPointAction(false, 'cluster', ${c.id}, 'Cluster ${c.id}')" class="bg-white text-black px-4 py-1 rounded-full font-black text-[8px]">ADD XP</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });
            } else if(activeTab === 'hero') {
                const heroes = q.clusters.flatMap(c => c.members.map(m => ({...m, cid: c.id}))).sort((a,b) => b.score - a.score);
                content.innerHTML = `<div class="flex justify-end mb-4 px-2"><button onclick="heroNameMode = (heroNameMode === 'nickname' ? 'original' : 'nickname'); renderArena();" class="text-[9px] font-black border border-cyan-400/30 px-4 py-2 rounded-full text-white uppercase">VIEWING: ${heroNameMode}</button></div>
                    <div id="hero-list-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3 name-fade-active">${heroes.map(h => `
                    <div class="zenith-card p-6 flex justify-between items-center">
                        <div>
                            <div class="font-bold text-sm uppercase text-white">${heroNameMode === 'nickname' ? (h.nickname || h.name) : h.name}</div>
                            <div class="text-[9px] opacity-30 italic text-white">${heroNameMode === 'nickname' ? h.name : h.nickname}</div>
                        </div>
                        <div class="flex items-center gap-3"><span class="text-xl font-black text-cyan-400">${h.score}</span><div class="flex flex-col gap-1">
                        <button onclick="openPointAction(false, 'player', '${h.id}', '${h.nickname || h.name}')" class="text-[8px] font-black bg-white/10 px-2 py-1 rounded text-white">ADD</button>
                        <button onclick="openPointAction(true, 'player', '${h.id}', '${h.nickname || h.name}')" class="text-[8px] font-black bg-red-500/10 text-red-400 px-2 py-1 rounded">MIN</button></div></div>
                    </div>`).join('')}</div>`;
            } else if(activeTab === 'nick') {
                const heroes = q.clusters.flatMap(c => c.members.map(m => ({...m, cid: c.id})));
                content.innerHTML = `
                    <div class="flex flex-col gap-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${heroes.map(h => `
                            <div class="zenith-card p-6">
                                <div class="text-[9px] opacity-30 uppercase mb-2 text-white">Registry: ${h.name}</div>
                                <input type="text" id="nick-in-${h.id}" value="${h.nickname}" class="w-full bg-white/5 border-b border-white/10 p-2 text-white outline-none focus:border-cyan-400 transition-all">
                            </div>`).join('')}
                        </div>
                        <div class="px-2">
                            <button onclick="saveAllNicknames()" class="w-full bg-cyan-500 text-black py-4 rounded-full font-black text-xs tracking-widest hover:bg-white transition-all">SYNC ALL NICKNAMES</button>
                        </div>
                    </div>`;
            } else if(activeTab === 'history') {
                content.innerHTML = `<div class="zenith-card p-8"><div class="space-y-3">${q.history.map(h => `
                    <div class="flex justify-between items-center text-[10px] bg-white/5 p-3 rounded-lg border-l-2 ${typeof h.amount === 'string' || h.amount > 0 ? 'border-cyan-500' : 'border-red-500'}">
                        <div class="flex flex-col">
                            <span class="opacity-60 text-white font-bold">${h.date}</span>
                            <span class="opacity-30 text-white">${h.time}</span>
                            <span class="text-[8px] opacity-30 text-white">${h.note || ''}</span>
                        </div>
                        <span class="font-bold uppercase text-white text-center flex-1">${h.target}</span>
                        <span class="${typeof h.amount === 'string' || h.amount > 0 ? 'text-cyan-400' : 'text-red-500'} font-black">${h.amount}</span>
                    </div>`).join('') || '<p class="text-center opacity-20 py-10">NO LOGS FOUND</p>'}</div></div>`;
            } else {
                const topC = [...q.clusters].sort((a,b) => b.members.reduce((s,m)=>s+m.score,0) - a.members.reduce((s,m)=>s+m.score,0));
                const topH = q.clusters.flatMap(c => c.members).sort((a,b) => b.score - a.score).slice(0, 10);
                content.innerHTML = `<div class="max-w-2xl mx-auto space-y-12 text-center">
                    <div><h4 class="text-yellow-500 font-['Orbitron'] text-2xl font-black mb-1">SUPREME CLUSTERS</h4><p class="text-[9px] opacity-40 mb-4 uppercase tracking-widest">Highest collective XP across the entire expedition unit.</p>
                        ${topC.map((c, i) => `<div class="zenith-card p-6 mb-3 border-l-4 border-yellow-500/50"><div class="flex justify-between items-center"><span class="font-black text-sm text-white">#${i+1} CLUSTER ${c.id}</span><span class="text-2xl font-black text-white">${c.members.reduce((s,m)=>s+m.score,0)}</span></div></div>`).join('')}</div>
                    <div><h4 class="text-cyan-400 font-['Orbitron'] text-2xl font-black mb-1">ELITE LEARNERS</h4><p class="text-[9px] opacity-40 mb-4 uppercase tracking-widest">The top individual performers based on personal merit.</p>
                        ${topH.map((h, i) => `<div class="zenith-card p-6 mb-3 ${i===0?'leader-aura':''} border-l-4 border-cyan-400/50"><div class="flex justify-between items-center"><span class="font-bold text-sm text-white">#${i+1} ${h.nickname || h.name}</span><span class="text-2xl font-black text-cyan-400">${h.score}</span></div></div>`).join('')}</div>
                </div>`;
            }
        }

        function viewClusterMembers(cid) {
            playSound('transition');
            const cluster = state.active[currentKey].clusters.find(c => c.id === cid);
            showModal(`
                <div class="zenith-card p-10 text-center max-w-sm" onclick="event.stopPropagation()">
                    <h2 class="font-['Orbitron'] text-cyan-400 font-black text-xl mb-6">CLUSTER ${cid} MANIFEST</h2>
                    <div class="space-y-2 mb-8 scroller max-h-60 overflow-y-auto">${cluster.members.map(m => `<div class="text-sm uppercase opacity-70 text-white">${m.nickname || m.name}</div>`).join('')}</div>
                    <p class="text-[9px] opacity-40 uppercase tracking-widest text-white">Click backdrop to dismiss</p>
                </div>
            `);
        }

        function triggerFinishSecurity() {
            playSound('congrats');
            showModal(`
                <div class="zenith-card p-10 text-center max-w-sm" onclick="event.stopPropagation()">
                    <h2 class="font-['Orbitron'] font-black text-xl mb-6 text-red-500">TERMINATION LOCK</h2>
                    <p class="text-[10px] opacity-60 mb-6 uppercase text-white">Enter Encryption Key to finalize mission results.</p>
                    <input id="finish-pass" type="password" placeholder="CONFIRM KEY" autofocus onkeydown="if(event.key==='Enter') verifyFinishKey()" class="w-full bg-white/5 border-b border-red-500 p-4 text-center outline-none mb-8 text-white">
                    <button onclick="verifyFinishKey()" class="w-full bg-red-600 py-3 rounded-full text-white font-black text-xs">FINALIZE MISSION</button>
                </div>
            `);
        }

        function verifyFinishKey() {
            if(document.getElementById('finish-pass').value === state.active[currentKey].pass) {
                document.getElementById('modal-overlay').onclick = null;
                let timer = 3;
                playSound('tick');
                showModal(`<div class="text-center" onclick="event.stopPropagation()"><div id="cd" class="text-9xl font-['Orbitron'] font-black text-cyan-400 animate-bounce">${timer}</div></div>`);
                const itv = setInterval(() => {
                    timer--;
                    if(timer > 0) {
                        playSound('tick');
                        document.getElementById('cd').innerText = timer;
                    }
                    else { 
                        clearInterval(itv); 
                        document.getElementById('modal-overlay').onclick = closeModal; 
                        playSound('victory'); 
                        showWinners(); 
                    }
                }, 1000);
            } else triggerError("INVALID SECURITY KEY");
        }

        function showWinners() {
            const q = state.active[currentKey];
            let mvp = { name: 'None', score: -1 };
            let topC = { id: 0, score: -1 };
            q.clusters.forEach(c => {
                let total = c.members.reduce((s,m)=>s+m.score,0);
                c.members.forEach(m => { if(m.score > mvp.score) mvp = m; });
                if(total > topC.score) topC = { id: c.id, score: total };
            });
            confetti({ particleCount: 300, spread: 100, origin: { y: 0.6 } });
            showModal(`
                <div class="zenith-card p-12 text-center max-w-2xl border-yellow-500" onclick="event.stopPropagation()">
                    <div class="text-7xl mb-4">üèÜ</div>
                    <h1 class="text-5xl font-['Orbitron'] font-black mb-10 italic text-white uppercase">Mission Complete</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                        <div class="p-8 bg-white/5 rounded-3xl border border-cyan-500/30">
                            <div class="text-[10px] opacity-40 mb-2 uppercase text-white">Supreme Cluster</div>
                            <div class="text-3xl font-black text-cyan-400 italic">CLUSTER ${topC.id}</div>
                        </div>
                        <div class="p-8 bg-white/5 rounded-3xl border border-yellow-500/30">
                            <div class="text-[10px] opacity-40 mb-2 uppercase text-white">Grand Champion</div>
                            <div class="text-3xl font-black text-yellow-500 italic">${mvp.nickname || mvp.name}</div>
                        </div>
                    </div>
                    <button onclick=\"exitToMenu()\" class=\"w-full bg-white text-black py-5 rounded-full font-black text-xs uppercase hover:bg-cyan-400 transition-all\">Terminate Link</button>
                </div>
            `);
        }

        function exitToMenu() { triggerLoading("DISCONNECTING...", () => location.reload()); }
    </script>
</body>
</html>

